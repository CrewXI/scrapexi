<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScrapeXi Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/midnight.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        cyber: ['"Orbitron"', 'sans-serif'],
                        tech: ['"Rajdhani"', 'sans-serif'],
                        mono: ['"Share Tech Mono"', 'monospace'],
                    },
                    colors: {
                        neonPink: '#FF00FF',
                        neonBlue: '#00FFFF',
                        neonGreen: '#00FF99',
                        darkBg: '#050510',
                    },
                    backgroundImage: {
                        'cyber-grid': "linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px)",
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050510;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(76, 29, 149, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 10% 10%, rgba(255, 0, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(0, 255, 255, 0.15) 0%, transparent 40%);
            overflow: hidden;
        }

        /* Moving Grid Background */
        .grid-overlay {
            position: fixed;
            top: 0; left: 0; width: 200%; height: 200%;
            background-image: linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: grid-move 20s linear infinite;
            z-index: -1;
            pointer-events: none;
        }
        @keyframes grid-move {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(40px) translateZ(-200px); }
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: rgba(20, 20, 35, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        /* Neon Borders */
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(45deg, transparent, rgba(0, 255, 255, 0.3), transparent, rgba(255, 0, 255, 0.3), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        /* Glowing Text */
        .text-glow-blue { text-shadow: 0 0 10px rgba(0, 255, 255, 0.7); }
        .text-glow-pink { text-shadow: 0 0 10px rgba(255, 0, 255, 0.7); }

        /* Cyber Input */
        .cyber-input {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 255, 0.2);
            color: #00FFFF;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
        }
        .cyber-input:focus {
            border-color: #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            outline: none;
        }

        /* Cyber Button */
        .cyber-btn {
            position: relative;
            background: transparent;
            border: 1px solid #00FFFF;
            color: #00FFFF;
            text-transform: uppercase;
            letter-spacing: 2px;
            overflow: hidden;
            transition: 0.3s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .cyber-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            text-shadow: 0 0 8px #00FFFF;
        }
        .cyber-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        .cyber-btn:hover::before {
            left: 100%;
        }

        /* CodeMirror overrides */
        .CodeMirror {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            height: 100% !important;
            color: #a5b3ce !important;
            font-family: 'Share Tech Mono', monospace !important;
        }
        .cm-variable { color: #ff79c6 !important; }
        .cm-string { color: #f1fa8c !important; }
        .cm-property { color: #8be9fd !important; }
        
        /* Accordion Animation */
        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 500px; /* Arbitrary large height */
            opacity: 1;
        }
        .chevron { transition: transform 0.3s ease; }
        .chevron.rotate { transform: rotate(180deg); }
    </style>
</head>
<body class="text-gray-300 font-tech h-screen flex flex-col text-base">

    <div class="grid-overlay"></div>

    <!-- Header -->
    <header class="h-20 flex items-center justify-between px-8 z-10 border-b border-white/5 bg-darkBg/80 backdrop-blur-sm flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-neonPink to-neonBlue rounded-lg blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                <div class="relative w-10 h-10 bg-black flex items-center justify-center rounded-lg border border-white/10">
                    <span class="font-cyber text-xl text-white">S</span>
                </div>
            </div>
            <div>
                <h1 class="font-cyber text-2xl text-white tracking-widest uppercase"><span class="text-neonBlue text-glow-blue">Scrape</span><span class="text-neonPink text-glow-pink">Xi</span></h1>
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-1.5 rounded-full bg-neonGreen animate-pulse shadow-[0_0_10px_#00FF99]"></div>
                    <span class="text-[10px] tracking-[0.2em] text-neonGreen uppercase">System Online</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3 px-4 py-2 glass-card rounded-lg">
                <img id="userAvatar" src="" class="w-8 h-8 rounded border border-white/20">
                <div class="text-right hidden sm:block">
                    <p id="userName" class="text-xs font-bold text-white tracking-wider uppercase">Operator</p>
                </div>
                <button onclick="logout()" class="text-gray-500 hover:text-red-500 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 01-3-3h4a3 3 0 013 3v1"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Interface -->
    <div class="flex-1 flex overflow-hidden p-6 gap-6 z-10">
        
        <!-- Sidebar Nav -->
        <nav class="w-16 lg:w-20 glass-card rounded-2xl flex flex-col items-center py-8 gap-8 flex-shrink-0">
            <a href="#" onclick="closeAllModals()" class="p-3 rounded-xl bg-white/5 border border-neonBlue/30 text-neonBlue shadow-[0_0_15px_rgba(0,255,255,0.2)] transition-all hover:scale-110">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </a>
            <a href="#" onclick="openTemplatesModal()" class="p-3 text-gray-500 hover:text-white hover:bg-white/5 rounded-xl transition-all" title="Template Library">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2z"/></svg>
            </a>
            <a href="#" onclick="openHistoryModal()" class="p-3 text-gray-500 hover:text-white hover:bg-white/5 rounded-xl transition-all" title="Search History">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </a>
            <div class="flex-1"></div>
            
            <div id="userStats" class="flex flex-col items-center gap-3 text-[9px] font-mono text-gray-500 w-full text-center border-t border-b border-white/5 py-4 mb-4">
                <div>
                    <span class="block text-neonBlue mb-0.5 tracking-wider">USED</span>
                    <span id="statUsed" class="text-white text-[10px]">...</span>
                </div>
                <div>
                    <span class="block text-neonPink mb-0.5 tracking-wider">LEFT</span>
                    <span id="statLeft" class="text-white text-[10px]">...</span>
                </div>
                <div>
                    <span class="block text-neonGreen mb-0.5 tracking-wider">PLAN</span>
                    <span id="statPlan" class="text-white text-[10px]">...</span>
                </div>
            </div>

            <a href="#" class="p-3 text-gray-500 hover:text-white hover:bg-white/5 rounded-xl transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </a>
        </nav>

        <!-- Configuration Module -->
        <div class="w-[500px] flex flex-col gap-0 overflow-hidden h-full glass-card rounded-2xl border border-white/10 flex-shrink-0 relative">
            
            <!-- Tabs Header -->
            <div class="flex border-b border-white/10 h-14 bg-black/40">
                <button onclick="switchTab('setup')" id="tab-setup" class="flex-1 font-cyber font-bold text-xs tracking-widest text-gray-500 hover:text-white hover:bg-white/5 transition border-b-2 border-transparent flex items-center justify-center gap-2 group">
                    <span class="group-hover:text-neonBlue transition">üéØ</span> SETUP
                </button>
                <button onclick="switchTab('schema')" id="tab-schema" class="flex-1 font-cyber font-bold text-xs tracking-widest text-gray-500 hover:text-white hover:bg-white/5 transition border-b-2 border-transparent flex items-center justify-center gap-2 group">
                    <span class="group-hover:text-neonGreen transition">üìù</span> SCHEMA
                </button>
                <button onclick="switchTab('config')" id="tab-config" class="flex-1 font-cyber font-bold text-xs tracking-widest text-gray-500 hover:text-white hover:bg-white/5 transition border-b-2 border-transparent flex items-center justify-center gap-2 group">
                    <span class="group-hover:text-neonPink transition">‚öôÔ∏è</span> CONFIG
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 relative overflow-hidden bg-black/20">
                
                <!-- TAB 1: SETUP -->
                <div id="view-setup" class="absolute inset-0 p-6 overflow-y-auto custom-scrollbar space-y-6 hidden">
                    
                    <!-- Target URL -->
                    <div>
                        <label class="text-xs font-bold text-neonBlue mb-2 block tracking-wide uppercase">Target Website</label>
                        <div class="relative group">
                            <input type="text" id="url" value="https://scrapeme.live/shop" 
                                class="cyber-input w-full h-12 px-4 rounded text-base font-mono bg-black/60 border-white/10 focus:border-neonBlue transition-all shadow-inner"
                                placeholder="https://example.com" oninput="updateSummary()">
                            <div class="absolute right-3 top-3 text-gray-500 group-hover:text-white transition cursor-pointer" title="Open in New Tab">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" onclick="window.open(document.getElementById('url').value, '_blank')"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Platform Preset -->
                    <div>
                        <label class="text-xs font-bold text-white mb-2 block tracking-wide uppercase opacity-70">Platform Preset</label>
                        <select id="sitePreset" class="cyber-input w-full h-12 px-4 rounded text-sm font-mono bg-black/60 border-white/10 focus:border-neonBlue transition-all appearance-none cursor-pointer hover:bg-white/5">
                            <option value="custom">CUSTOM / DIRECT URL</option>
                        </select>
                    </div>

                    <!-- Dynamic Inputs -->
                    <div id="urlBuilderModule" class="hidden">
                        <div id="urlBuilderFields" class="space-y-4 pt-2">
                            <!-- Dynamic Inputs injected here -->
                        </div>
                    </div>

                </div>

                <!-- TAB 2: SCHEMA -->
                <div id="view-schema" class="absolute inset-0 flex flex-col hidden">
                    <!-- Sub Tabs -->
                    <div class="h-10 bg-black/40 border-b border-white/5 flex items-center px-2 gap-2 flex-shrink-0">
                        <button onclick="switchSchemaMode('form')" id="btn-schema-form" class="px-3 py-1 text-[10px] font-cyber font-bold text-neonBlue bg-white/10 rounded hover:bg-white/20 transition border border-neonBlue/30">WIZARD</button>
                        <button onclick="switchSchemaMode('json')" id="btn-schema-json" class="px-3 py-1 text-[10px] font-cyber font-bold text-gray-500 hover:text-white transition border border-transparent">JSON EDITOR</button>
                    </div>

                    <!-- FORM MODE -->
                    <div id="schema-mode-form" class="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-6">
                        <!-- Root Entity -->
                        <div>
                            <label class="text-[10px] text-gray-400 font-mono mb-2 block uppercase">I want to extract a list of...</label>
                            <div class="flex gap-2">
                                <select id="schemaEntitySelect" class="cyber-input flex-1 h-10 px-2 text-xs rounded bg-black/60 cursor-pointer" onchange="handleEntityChange()">
                                    <option value="jobs">Jobs</option>
                                    <option value="people">People</option>
                                    <option value="products">Products</option>
                                    <option value="companies">Companies</option>
                                    <option value="properties">Real Estate</option>
                                    <option value="articles">Articles</option>
                                    <option value="reviews">Reviews</option>
                                    <option value="events">Events</option>
                                    <option value="cars">Cars</option>
                                    <option value="custom">Custom / Other...</option>
                                </select>
                                <input type="text" id="schemaEntityCustom" class="cyber-input flex-1 h-10 px-2 text-xs rounded bg-black/60 hidden" placeholder="e.g. pokemon" oninput="updateSchemaFromForm()">
                            </div>
                        </div>

                        <!-- Fields -->
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <label class="text-[10px] text-gray-400 font-mono uppercase">With these details</label>
                                <button onclick="addFieldRow()" class="text-neonGreen text-xs font-bold hover:text-white transition flex items-center gap-1">
                                    <span class="text-lg">+</span> ADD FIELD
                                </button>
                            </div>
                            <div id="schemaFieldsContainer" class="space-y-2">
                                <!-- Rows injected here -->
                            </div>
                        </div>
                        
                        <div class="text-[10px] text-gray-500 font-mono">
                            * This wizard automatically generates the extraction query. Switch to "JSON EDITOR" to fine-tune.
                        </div>
                    </div>

                    <!-- JSON MODE -->
                    <div id="schema-mode-json" class="flex-1 relative hidden">
                        <textarea id="query">{
    products[] {
        name
        price
        rating
    }
}</textarea>
                    </div>
                </div>

                <!-- TAB 3: CONFIG -->
                <div id="view-config" class="absolute inset-0 p-6 overflow-y-auto custom-scrollbar space-y-8 hidden">
                    
                    <!-- Pagination -->
                    <div class="bg-white/5 rounded-xl p-5 border border-white/5">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-sm font-bold text-white">Pagination</h3>
                                <p class="text-[10px] text-gray-500">Auto-traverse multiple pages</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="pagination" class="sr-only peer" onchange="updateSummary()">
                                <div class="w-10 h-5 bg-gray-800 rounded-full peer-checked:bg-neonBlue/20 border border-gray-600 peer-checked:border-neonBlue transition-all relative peer-checked:[&>div]:translate-x-5 peer-checked:[&>div]:bg-neonBlue">
                                    <div class="absolute top-0.5 left-0.5 w-3.5 h-3.5 bg-gray-400 rounded-full transition-all"></div>
                                </div>
                            </label>
                        </div>
                        <div id="paginationControls" class="grid grid-cols-2 gap-4 hidden">
                            <div>
                                <label class="text-[10px] text-gray-400 block mb-1 uppercase">Start</label>
                                <input type="number" id="startPage" value="1" min="1" class="cyber-input w-full p-2 rounded text-center font-mono bg-black/50" oninput="updateSummary()">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 block mb-1 uppercase">End</label>
                                <input type="number" id="endPage" value="3" min="1" class="cyber-input w-full p-2 rounded text-center font-mono bg-black/50" oninput="updateSummary()">
                            </div>
                        </div>
                    </div>

                    <!-- Stealth -->
                    <div class="bg-white/5 rounded-xl p-5 border border-white/5">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-sm font-bold text-white">Stealth Mode</h3>
                                <p class="text-[10px] text-gray-500">Anti-detection protocols</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="stealthMode" class="sr-only peer" onchange="updateSummary()">
                                <div class="w-10 h-5 bg-gray-800 rounded-full peer-checked:bg-purple-500/20 border border-gray-600 peer-checked:border-purple-500 transition-all relative peer-checked:[&>div]:translate-x-5 peer-checked:[&>div]:bg-purple-500">
                                    <div class="absolute top-0.5 left-0.5 w-3.5 h-3.5 bg-gray-400 rounded-full transition-all"></div>
                                </div>
                            </label>
                        </div>
                        <div id="jitterPanel" class="hidden pt-2 border-t border-white/10 mt-2">
                            <div class="flex justify-between text-xs text-gray-400 mb-2 mt-2">
                                <span>WAIT JITTER</span>
                                <span id="waitDisplay" class="text-purple-400 font-mono">2s</span>
                            </div>
                            <input type="range" id="waitTime" min="1" max="15" value="2" class="w-full accent-purple-500 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="updateWaitDisplay(this.value)">
                        </div>
                    </div>

                    <!-- Auth -->
                    <div class="bg-white/5 rounded-xl p-5 border border-white/5">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-sm font-bold text-white">Authentication</h3>
                                <p class="text-[10px] text-gray-500">Login credentials or session cookies</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Login Toggle -->
                            <div class="flex items-center justify-between bg-black/30 p-3 rounded">
                                <span class="text-xs text-gray-300">Standard Login</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="loginEnabled" class="sr-only peer" onchange="updateSummary()">
                                    <div class="w-8 h-4 bg-gray-800 rounded-full peer-checked:bg-neonPink/20 border border-gray-600 peer-checked:border-neonPink transition-all relative peer-checked:[&>div]:translate-x-4 peer-checked:[&>div]:bg-neonPink">
                                        <div class="absolute top-0.5 left-0.5 w-2.5 h-2.5 bg-gray-400 rounded-full transition-all"></div>
                                    </div>
                                </label>
                            </div>
                            <div id="loginParams" class="hidden space-y-2">
                                <form onsubmit="return false;" class="contents">
                                    <input type="text" id="loginUrl" placeholder="Login Page URL" class="cyber-input w-full p-2 text-xs rounded bg-black/50">
                                    <input type="text" id="username" placeholder="Username" class="cyber-input w-full p-2 text-xs rounded bg-black/50" autocomplete="username">
                                    <input type="password" id="password" placeholder="Password" class="cyber-input w-full p-2 text-xs rounded bg-black/50" autocomplete="current-password">
                                </form>
                            </div>

                            <!-- Session Toggle -->
                            <div class="flex items-center justify-between bg-black/30 p-3 rounded">
                                <span class="text-xs text-gray-300">Session Cookie</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="sessionEnabled" class="sr-only peer" onchange="updateSummary()">
                                    <div class="w-8 h-4 bg-gray-800 rounded-full peer-checked:bg-neonGreen/20 border border-gray-600 peer-checked:border-neonGreen transition-all relative peer-checked:[&>div]:translate-x-4 peer-checked:[&>div]:bg-neonGreen">
                                        <div class="absolute top-0.5 left-0.5 w-2.5 h-2.5 bg-gray-400 rounded-full transition-all"></div>
                                    </div>
                                </label>
                            </div>
                            <div id="sessionParams" class="hidden">
                                <textarea id="sessionJson" placeholder='Paste cookie JSON here...' class="cyber-input w-full h-20 text-xs p-2 rounded font-mono bg-black/50 resize-none"></textarea>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <!-- Mission Summary Footer -->
            <div class="bg-black/40 border-t border-white/10 p-4">
                <div class="flex items-center justify-between text-[10px] font-mono text-gray-500 mb-3 uppercase tracking-wider">
                    <span>Mission Config</span>
                    <span id="configSummary" class="text-neonBlue">READY</span>
                </div>
                
                <button id="scrapeBtn" onclick="runScraper()" class="cyber-btn w-full py-4 font-bold text-lg tracking-[0.2em] bg-neonBlue/5 hover:bg-neonBlue/10 border border-neonBlue/50 text-neonBlue hover:text-white transition-all shadow-[0_0_20px_rgba(0,255,255,0.1)] hover:shadow-[0_0_30px_rgba(0,255,255,0.3)]">
                    INITIALIZE
                </button>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="flex-1 glass-card rounded-2xl flex flex-col overflow-hidden">
            <div class="h-12 border-b border-white/5 flex items-center justify-between px-6 bg-black/20 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-neonBlue animate-pulse"></div>
                        <span class="font-mono text-sm text-neonBlue tracking-widest">DATA_STREAM</span>
                    </div>
                    <div class="text-xs font-mono text-gray-500 flex gap-3 border-l border-white/10 pl-3">
                        <span id="resultCount">ITEMS: 0</span>
                        <span id="charCount">SIZE: 0B</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <!-- View Toggles -->
                    <div class="flex bg-black/40 rounded p-0.5 border border-white/10 mr-2">
                        <button onclick="toggleView('json')" id="viewBtnJson" class="px-2 py-0.5 text-[10px] font-mono rounded bg-white/10 text-white transition-all">JSON</button>
                        <button onclick="toggleView('table')" id="viewBtnTable" class="px-2 py-0.5 text-[10px] font-mono rounded text-gray-500 hover:text-white transition-all">TABLE</button>
                    </div>

                    <button onclick="saveCurrentAsTemplate()" class="text-gray-500 hover:text-neonBlue font-mono text-sm transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                        SAVE_TPL
                    </button>
                    <button onclick="openTemplatesModal()" class="text-gray-500 hover:text-neonPink font-mono text-sm transition-colors flex items-center gap-1 mr-4">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2z"/></svg>
                        EXPLORE
                    </button>
                    <div class="w-px h-4 bg-white/10 self-center mx-1"></div>
                    <button onclick="copyToClipboard()" class="text-gray-500 hover:text-neonPink font-mono text-sm transition-colors">[COPY]</button>
                    <button onclick="downloadRawJson()" class="text-gray-500 hover:text-white font-mono text-sm transition-colors">[RAW]</button>
                    <button onclick="downloadCsv()" class="text-gray-500 hover:text-white font-mono text-sm transition-colors">[CSV]</button>
                </div>
            </div>
            <div id="output" class="flex-1 p-6 overflow-auto font-mono text-base text-gray-400 custom-scrollbar relative">
                <!-- Placeholder (Initial State) -->
                <div id="outputPlaceholder" class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-50">
                    <div class="w-24 h-24 border border-dashed border-white/20 rounded-full flex items-center justify-center animate-[spin_10s_linear_infinite]">
                        <div class="w-16 h-16 border border-white/10 rounded-full"></div>
                    </div>
                    <p class="tracking-widest text-xs">AWAITING_INPUT_STREAM...</p>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="hidden h-full flex flex-col items-center justify-center space-y-4 font-mono">
                    <div class="text-neonBlue text-xs animate-pulse">ESTABLISHING UPLINK...</div>
                    <div class="w-64 h-1 bg-gray-800 rounded overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-neonBlue to-neonPink animate-[shimmer_2s_infinite] w-1/2"></div>
                    </div>
                    <div id="loadingText" class="text-xs text-gray-500">Target: ...</div>
                </div>

                <!-- Status Message (Error/Cancel) -->
                <div id="statusMessage" class="hidden h-full flex flex-col items-center justify-center space-y-4 font-mono">
                    <!-- Injected via JS -->
                </div>

                <!-- Data Views -->
                <pre id="jsonView" class="text-neonGreen text-xs leading-relaxed hidden"></pre>
                <div id="tableView" class="hidden w-full"></div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="glass-card rounded-xl max-w-2xl w-full p-8 relative border-neonGreen/30 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl">&times;</button>
            
            <h2 class="text-xl font-cyber text-neonGreen mb-6 tracking-wide flex items-center gap-3">
                <span class="text-2xl">üç™</span> HOW TO BYPASS LOGIN
            </h2>
            
            <div class="space-y-8 font-mono text-sm text-gray-300">
                
                <div class="bg-black/40 p-5 rounded border-l-4 border-neonBlue">
                    <h3 class="text-neonBlue font-bold text-base mb-3 uppercase">Method 1: The Easy Way (Chrome Extension)</h3>
                    <ol class="list-decimal pl-5 space-y-3 marker:text-neonBlue">
                        <li>Install the <strong>"EditThisCookie"</strong> extension for Chrome/Edge.</li>
                        <li>Go to the website you want to scrape (e.g., <em>storyxi.com</em>) and <strong>log in manually</strong>.</li>
                        <li>Click the cookie extension icon in your browser toolbar.</li>
                        <li>Click the <strong>"Export"</strong> button (it looks like an arrow pointing out ‚ûú). This copies the cookies to your clipboard.</li>
                        <li><strong>Paste</strong> the copied text directly into the "Session State" box on this dashboard.</li>
                    </ol>
                </div>

                <div class="bg-black/40 p-5 rounded border-l-4 border-neonPink">
                    <h3 class="text-neonPink font-bold text-base mb-3 uppercase">Method 2: The Developer Way (Terminal)</h3>
                    <p class="mb-3 text-xs text-gray-400">Use this if you have Node.js installed on your computer.</p>
                    <ol class="list-decimal pl-5 space-y-3 marker:text-neonPink">
                        <li>Open your computer's <strong>Terminal</strong> or Command Prompt.</li>
                        <li>Copy and paste this command (replace the URL with your target):
                            <div class="mt-2 bg-black p-3 rounded border border-white/10 relative group">
                                <code class="text-neonPink text-xs break-all">npx playwright codegen --save-storage=auth.json https://www.storyxi.com</code>
                            </div>
                        </li>
                        <li>A browser window will open. <strong>Log in</strong> to the site inside that window.</li>
                        <li>Once logged in, <strong>close</strong> the browser window.</li>
                        <li>A new file named <code>auth.json</code> was created in your current folder. Open it with a text editor (Notepad, TextEdit, VS Code).</li>
                        <li>Copy the <strong>entire content</strong> of that file and paste it into the box here.</li>
                    </ol>
                </div>

                <div class="text-xs text-gray-500 border-t border-white/10 pt-4">
                    <strong>Why do I need this?</strong> <br>
                    Automated bots cannot easily click "Login with Google" buttons because Google blocks them. By copying your "Session Cookies", you are effectively telling the bot: <em>"Pretend to be me, I'm already logged in."</em>
                </div>
            </div>
            
            <div class="mt-8 text-right">
                <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="cyber-btn px-6 py-2 text-xs font-bold">UNDERSTOOD</button>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templatesModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="glass-card rounded-xl max-w-6xl w-full h-[90vh] flex flex-col border-neonPink/30">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-white/5">
                <h2 class="text-2xl font-cyber text-white tracking-wide flex items-center gap-3">
                    <span class="text-neonPink">TEMPLATE</span> LIBRARY
                </h2>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="text" placeholder="SEARCH_MODULES..." class="cyber-input bg-black/50 pl-10 pr-4 py-2 rounded text-xs w-64">
                        <svg class="w-4 h-4 text-gray-500 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <button onclick="document.getElementById('templatesModal').classList.add('hidden')" class="text-gray-500 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-black/20">
                
                <!-- User Saved Section -->
                <div id="userTemplatesSection" class="mb-8 hidden">
                    <h3 class="text-neonBlue font-cyber text-sm mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-neonBlue rounded-full"></span> LOCAL_STORAGE
                    </h3>
                    <div id="userTemplatesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- User Templates Injected Here -->
                    </div>
                </div>

                <!-- System Templates -->
                <h3 class="text-neonPink font-cyber text-sm mb-4 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-neonPink rounded-full"></span> SYSTEM_MODULES
                </h3>
                <div id="systemTemplatesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- System Templates Injected Here -->
                </div>
            </div>
        </div>
    </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="glass-card rounded-xl max-w-5xl w-full h-[90vh] flex flex-col border-neonBlue/30">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-white/5">
                <h2 class="text-2xl font-cyber text-white tracking-wide flex items-center gap-3">
                    <span class="text-neonBlue">MISSION</span> LOGS
                </h2>
                <div class="flex items-center gap-4">
                    <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="text-gray-500 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-0 bg-black/20">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-white/5 text-xs uppercase font-mono text-gray-400 sticky top-0 backdrop-blur-md">
                        <tr>
                            <th class="p-4 border-b border-white/10">Status</th>
                            <th class="p-4 border-b border-white/10">Target</th>
                            <th class="p-4 border-b border-white/10">Items</th>
                            <th class="p-4 border-b border-white/10">Data Usage</th>
                            <th class="p-4 border-b border-white/10">Time</th>
                            <th class="p-4 border-b border-white/10 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="text-sm font-mono text-gray-300">
                        <!-- History Rows Injected Here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Stealth Help Modal -->
    <div id="stealthHelpModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="glass-card rounded-xl max-w-2xl w-full p-8 relative border-purple-500/30 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <button onclick="document.getElementById('stealthHelpModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl">&times;</button>
            
            <h2 class="text-xl font-cyber text-purple-400 mb-6 tracking-wide flex items-center gap-3">
                <span class="text-2xl">üëª</span> STEALTH PROTOCOLS
            </h2>
            
            <div class="space-y-6 font-mono text-sm text-gray-300">
                <p>
                    Standard scraping bots are "loud" and easily detected by modern security systems (Cloudflare, Akamai, etc.). 
                    <strong>Stealth Mode</strong> makes your scraper act more like a human.
                </p>

                <div class="bg-black/40 p-5 rounded border-l-4 border-purple-500">
                    <h3 class="text-purple-400 font-bold text-base mb-3 uppercase">When to use this?</h3>
                    <ul class="list-disc pl-5 space-y-2 marker:text-purple-500">
                        <li>The target site is blocking you (403 Forbidden errors).</li>
                        <li>You see CAPTCHAs or "Verify you are human" screens.</li>
                        <li>You need to scrape high-security sites like LinkedIn, Instagram, or Twitter.</li>
                    </ul>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white/5 p-4 rounded border border-white/10">
                        <strong class="text-white block mb-2">‚úÖ PROS</strong>
                        <ul class="text-xs space-y-1 text-gray-400">
                            <li>‚Ä¢ Evades bot detection scripts</li>
                            <li>‚Ä¢ Randomizes mouse movements</li>
                            <li>‚Ä¢ Masks browser automation flags</li>
                        </ul>
                    </div>
                    <div class="bg-white/5 p-4 rounded border border-white/10">
                        <strong class="text-white block mb-2">‚ö†Ô∏è CONS</strong>
                        <ul class="text-xs space-y-1 text-gray-400">
                            <li>‚Ä¢ Slightly slower execution</li>
                            <li>‚Ä¢ Higher memory usage</li>
                            <li>‚Ä¢ Not 100% guaranteed (nothing is)</li>
                        </ul>
                    </div>
                </div>

                <div class="text-xs text-gray-500 border-t border-white/10 pt-4">
                    <strong>Wait Time Jitter:</strong> <br>
                    This slider adds a random delay (e.g., 2s ¬± 500ms) between actions. Increasing this makes the bot seem "thoughtful" rather than instant, drastically reducing ban rates.
                </div>
            </div>
            
            <div class="mt-8 text-right">
                <button onclick="document.getElementById('stealthHelpModal').classList.add('hidden')" class="cyber-btn px-6 py-2 text-xs font-bold border-purple-500 text-purple-400 hover:shadow-[0_0_20px_rgba(168,85,247,0.4)]">INITIATE PROTOCOL</button>
            </div>
        </div>
    </div>

    <script>
        var currentData = null;
        
        // Site Presets Configuration
        const SITE_PRESETS = {
            'custom': { label: 'CUSTOM / DIRECT URL', pattern: '', fields: [] },
            'linkedin_people': { 
                label: 'LINKEDIN (PEOPLE)', 
                pattern: 'https://www.linkedin.com/search/results/people/?keywords={keywords}&origin=SWITCH_SEARCH_VERTICAL',
                fields: [{ key: 'keywords', label: 'KEYWORDS', placeholder: 'e.g. Software Engineer' }]
            },
            'linkedin_jobs': { 
                label: 'LINKEDIN (JOBS)', 
                pattern: 'https://www.linkedin.com/jobs/search/?keywords={keywords}&location={location}',
                fields: [
                    { key: 'keywords', label: 'JOB TITLE', placeholder: 'e.g. Python Developer' },
                    { key: 'location', label: 'LOCATION', placeholder: 'e.g. Remote' }
                ]
            },
            'google': { 
                label: 'GOOGLE SEARCH', 
                pattern: 'https://www.google.com/search?q={query}&num=100',
                fields: [{ key: 'query', label: 'QUERY', placeholder: 'e.g. best headphones 2025' }]
            },
            'amazon': { 
                label: 'AMAZON PRODUCTS', 
                pattern: 'https://www.amazon.com/s?k={keyword}',
                fields: [{ key: 'keyword', label: 'PRODUCT', placeholder: 'e.g. mechanical keyboard' }]
            },
            'yelp': { 
                label: 'YELP BUSINESS', 
                pattern: 'https://www.yelp.com/search?find_desc={desc}&find_loc={loc}',
                fields: [
                    { key: 'desc', label: 'FIND', placeholder: 'e.g. Pizza' },
                    { key: 'loc', label: 'NEAR', placeholder: 'e.g. New York, NY' }
                ]
            },
            'indeed': { 
                label: 'INDEED JOBS', 
                pattern: 'https://www.indeed.com/jobs?q={q}&l={l}',
                fields: [
                    { key: 'q', label: 'WHAT', placeholder: 'e.g. Nurse' },
                    { key: 'l', label: 'WHERE', placeholder: 'e.g. Chicago' }
                ]
            },
            'zillow': { 
                label: 'ZILLOW HOMES', 
                pattern: 'https://www.zillow.com/homes/{location}_rb/',
                fields: [{ key: 'location', label: 'CITY/ZIP', placeholder: 'e.g. 90210' }]
            },
            'yellowpages': { 
                label: 'YELLOW PAGES', 
                pattern: 'https://www.yellowpages.com/search?search_terms={terms}&geo_location_terms={geo}',
                fields: [
                    { key: 'terms', label: 'TERM', placeholder: 'e.g. Plumbers' },
                    { key: 'geo', label: 'LOCATION', placeholder: 'e.g. Miami' }
                ]
            },
            'booking': { 
                label: 'BOOKING.COM', 
                pattern: 'https://www.booking.com/searchresults.html?ss={dest}',
                fields: [{ key: 'dest', label: 'DESTINATION', placeholder: 'e.g. Tokyo' }]
            },
            'tripadvisor': { 
                label: 'TRIPADVISOR', 
                pattern: 'https://www.tripadvisor.com/Search?q={query}',
                fields: [{ key: 'query', label: 'SEARCH', placeholder: 'e.g. Hotels in Rome' }]
            }
        };

        // Initialize Supabase
        let supabase;
        
        async function initSupabase() {
            // Determine API Base URL
            const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:8000' 
                : ''; 

            try {
                // Fetch config from backend to avoid hardcoding keys in frontend source
                const res = await fetch(`${API_BASE}/config`); // Use dynamic path
                const config = await res.json();
                
                if (config.supabase_url && config.supabase_anon_key) {
                    // @ts-ignore
                    // Ensure window.supabase object from CDN exists before using it
                    if (window.supabase && window.supabase.createClient) {
                        supabase = window.supabase.createClient(config.supabase_url, config.supabase_anon_key);
                        console.log("Supabase initialized");
                        
                        // Now check auth
                        await checkAuth();
                    } else {
                        console.error("Supabase SDK not loaded yet");
                        // Retry once after small delay if SDK script is racing
                        setTimeout(() => initSupabase(), 500); 
                        return;
                    }
                } else {
                    console.error("Supabase config missing", config);
                }
            } catch (e) {
                console.error("Failed to init Supabase:", e);
            }
        }
        
        // Call init immediately
        initSupabase();

        // Initialize Dropdown
        const presetSelect = document.getElementById('sitePreset');
        if (presetSelect) {
            presetSelect.innerHTML = '';
            Object.entries(SITE_PRESETS).forEach(([key, config]) => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = config.label;
                presetSelect.appendChild(opt);
            });
            presetSelect.addEventListener('change', (e) => applySitePreset(e.target.value));
        }

        function applySitePreset(key) {
            const config = SITE_PRESETS[key];
            if (!config) return;

            const container = document.getElementById('urlBuilderFields');
            if (!container) return;
            container.innerHTML = '';
            
            if (key === 'custom') {
                currentUrlBuilder = null;
                // Restore default placeholder or keep current URL? 
                // Let's keep current for custom flexibility
                return;
            }

            currentUrlBuilder = config;
            
            config.fields.forEach(field => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="text-[10px] text-gray-500 font-mono mb-1 block uppercase">${field.label}</label>
                    <input type="text" data-key="${field.key}" 
                        class="cyber-input w-full p-2 rounded text-xs font-mono builder-input" 
                        placeholder="${field.placeholder || ''}"
                        oninput="updateBuiltUrl()">
                `;
                container.appendChild(div);
            });
            
            // Set base pattern
            document.getElementById('url').value = config.pattern;
        }

        // Cache for loaded templates
        let LOADED_TEMPLATES = {};
        let currentUrlBuilder = null;

        async function openTemplatesModal() {
            document.getElementById('templatesModal').classList.remove('hidden');
            await fetchAndRenderTemplates();
        }

        async function fetchAndRenderTemplates() {
            const container = document.getElementById('systemTemplatesGrid'); 
            const userContainer = document.getElementById('userTemplatesGrid');
            const userSection = document.getElementById('userTemplatesSection');

            if(!container) return;
            
            container.innerHTML = '<div class="text-neonBlue animate-pulse">LOADING_MODULES...</div>';

            if (!supabase) {
                 // Try to use global just in case
                 if (window.supabase && window.supabase.auth) supabase = window.supabase;
            }

            if (!supabase || !supabase.from) {
                 container.innerHTML = '<div class="text-red-500">DATABASE_CONNECTION_OFFLINE</div>';
                 renderUserTemplates();
                 return;
            }

            try {
                // 1. Fetch System Templates
                const { data: systemTemplates, error: sysError } = await supabase
                    .from('templates')
                    .select('*')
                    .eq('type', 'system');

                if (sysError) throw sysError;

                // 2. Fetch User Private Templates
                let privateTemplates = [];
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    const { data, error: userError } = await supabase
                        .from('templates')
                        .select('*')
                        .eq('user_id', session.user.id)
                        .order('created_at', { ascending: false });
                    
                    if (!userError && data) privateTemplates = data;
                }

                // --- Render System Templates ---
                container.innerHTML = '';
                systemTemplates.forEach(tpl => renderTemplateCard(tpl, container));

                // --- Render Private Templates ---
                if (privateTemplates.length > 0) {
                    userSection.classList.remove('hidden');
                    userContainer.innerHTML = '';
                    // Rename header to reflect cloud status
                    userSection.querySelector('h3').innerHTML = '<span class="w-1.5 h-1.5 bg-neonBlue rounded-full"></span> MY TEMPLATES (CLOUD)';
                    
                    privateTemplates.forEach(tpl => renderTemplateCard(tpl, userContainer, true));
                }

            } catch (e) {
                console.error("Error loading templates:", e);
                container.innerHTML = `<div class="text-red-500">ERROR_LOADING_DATABASE: ${e.message}</div>`;
            }
            
            // Also render local ones if any exist (legacy support)
            renderUserTemplates(); 
        }

        function renderTemplateCard(tpl, container, isUser = false) {
            LOADED_TEMPLATES[tpl.id] = tpl; // Cache
            
            const config = typeof tpl.config === 'string' ? JSON.parse(tpl.config) : tpl.config;
            
            const card = document.createElement('div');
            card.className = 'glass-card p-5 rounded-xl border border-white/5 hover:border-neonBlue/50 transition-all group relative overflow-hidden';
            
            let badges = '';
            if (config.sessionEnabled) badges += `<div class="absolute top-0 right-0 bg-neonBlue/10 px-2 py-1 rounded-bl text-[10px] text-neonBlue font-mono border-l border-b border-neonBlue/20">SESSION</div>`;
            else if (config.loginEnabled) badges += `<div class="absolute top-0 right-0 bg-neonPink/10 px-2 py-1 rounded-bl text-[10px] text-neonPink font-mono border-l border-b border-neonPink/20">CREDS</div>`;
            
            if (isUser) {
                 badges += `<div class="absolute top-0 right-0 bg-green-500/10 px-2 py-1 rounded-bl text-[10px] text-green-400 font-mono border-l border-b border-green-500/20" style="right: ${config.sessionEnabled || config.loginEnabled ? '60px' : '0'}">PRIVATE</div>`;
            }

            card.innerHTML = `
                ${badges}
                <h4 class="text-white font-bold text-lg mb-1">${tpl.name}</h4>
                <p class="text-gray-500 text-xs font-mono mb-4 h-8 overflow-hidden">${tpl.description || tpl.url}</p>
                
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between text-[10px] text-gray-400 font-mono border-b border-white/5 pb-1">
                        <span>PAGINATION</span> <span class="${config.pagination ? 'text-neonGreen' : 'text-gray-600'}">${config.pagination ? `ON (${config.maxPages})` : 'OFF'}</span>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-400 font-mono border-b border-white/5 pb-1">
                        <span>STEALTH</span> <span class="${config.stealth ? 'text-purple-400' : 'text-gray-600'}">${config.stealth ? 'ACTIVE' : 'OFF'}</span>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-400 font-mono border-b border-white/5 pb-1">
                        <span>AUTH</span> <span class="${config.loginEnabled || config.sessionEnabled ? 'text-yellow-500' : 'text-gray-600'}">${config.sessionEnabled ? 'COOKIE' : (config.loginEnabled ? 'CREDS' : 'NONE')}</span>
                    </div>
                </div>

                <button onclick="loadTemplate('${tpl.id}')" class="cyber-btn w-full py-2 text-xs font-bold group-hover:shadow-[0_0_15px_rgba(0,255,255,0.3)]">LOAD_MODULE</button>
            `;
            container.appendChild(card);
        }

        function loadTemplate(templateId) {
            let tpl = LOADED_TEMPLATES[templateId];
            
            // Fallback to local custom templates
            if (!tpl) {
                const saved = JSON.parse(localStorage.getItem('user_templates') || '{}');
                tpl = saved[templateId];
            }

            if (!tpl) return;

            // Parse config if needed
            const config = tpl.config || tpl; // Handle DB vs Local structure difference
            
            // Handle URL Builder
            const builder = config.urlBuilder;
            const builderModule = document.getElementById('urlBuilderModule');
            const builderContainer = document.getElementById('urlBuilderFields');
            
            if (builder && builder.pattern && builder.fields) {
                currentUrlBuilder = builder;
                builderModule.classList.remove('hidden');
                builderContainer.innerHTML = '';
                
                builder.fields.forEach(field => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label class="text-[10px] text-gray-400 font-mono mb-1 block uppercase">${field.label}</label>
                        <input type="text" data-key="${field.key}" 
                            class="cyber-input w-full p-2 rounded text-xs font-mono builder-input" 
                            placeholder="${field.placeholder || ''}"
                            oninput="updateBuiltUrl()">
                    `;
                    builderContainer.appendChild(div);
                });
                
                // Trigger initial build (clears URL until typed or keeps default?)
                // Let's not clear immediately, wait for input
            } else {
                currentUrlBuilder = null;
                builderModule.classList.add('hidden');
            }

            // Fill Fields
            document.getElementById('url').value = tpl.url;
            editor.setValue(tpl.query);
            
            // Set Toggles & Sliders
            document.getElementById('pagination').checked = config.pagination;
            document.getElementById('pagination').dispatchEvent(new Event('change'));
            
            document.getElementById('startPage').value = config.startPage || 1;
            document.getElementById('endPage').value = config.endPage || config.maxPages || 1;
            
            document.getElementById('stealthMode').checked = config.stealth;
            
            document.getElementById('waitTime').value = config.waitTime || 2;
            updateWaitDisplay(config.waitTime || 2);

            // Auth Logic
            document.getElementById('loginEnabled').checked = config.loginEnabled || false;
            document.getElementById('loginEnabled').dispatchEvent(new Event('change'));
            
            if (config.loginEnabled) {
                document.getElementById('username').value = config.username || '';
                document.getElementById('password').value = config.password || '';
                document.getElementById('loginUrl').value = tpl.url; 
            }

            document.getElementById('sessionEnabled').checked = config.sessionEnabled || false;
            document.getElementById('sessionEnabled').dispatchEvent(new Event('change'));

            // Close Modal
            document.getElementById('templatesModal').classList.add('hidden');
        }

        async function saveCurrentAsTemplate() {
            const name = prompt("Enter a name for this template (e.g., 'My Custom Scraper'):");
            if (!name) return;

            // Get current user
            let userId = null;
            if (supabase) {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) userId = session.user.id;
            }

            const tpl = {
                name: name,
                url: document.getElementById('url').value,
                query: editor.getValue(),
                type: 'private', // Changed from 'user' to 'private' to match DB constraint
                user_id: userId, // REQUIRED for RLS
                config: {
                    pagination: document.getElementById('pagination').checked,
                    startPage: parseInt(document.getElementById('startPage').value) || 1,
                    endPage: parseInt(document.getElementById('endPage').value) || 1,
                    maxPages: parseInt(document.getElementById('endPage').value) || 1, // Fallback
                    stealth: document.getElementById('stealthMode').checked,
                    loginEnabled: document.getElementById('loginEnabled').checked,
                    username: document.getElementById('username').value, 
                    sessionEnabled: document.getElementById('sessionEnabled').checked,
                    waitTime: parseInt(document.getElementById('waitTime').value) || 2,
                }
            };

            if (supabase) {
                 const { data, error } = await supabase
                    .from('templates')
                    .insert([tpl])
                    .select();
                    
                 if (error) {
                     console.error("Error saving to DB:", error);
                     alert("Failed to save to database. Saving locally instead.");
                     // Fallback
                 } else {
                     alert("Template saved to Database!");
                     return;
                 }
            }

            // Local Storage Fallback
            const localTpl = { ...tpl, id: 'user_' + Date.now(), timestamp: Date.now() };
            const saved = JSON.parse(localStorage.getItem('user_templates') || '{}');
            saved[localTpl.id] = localTpl;
            localStorage.setItem('user_templates', JSON.stringify(saved));
            
            alert("Template saved locally!");
        }

        function renderUserTemplates() {
            // ... (Same as before, but adapted for consistency)
            const saved = JSON.parse(localStorage.getItem('user_templates') || '{}');
            const container = document.getElementById('userTemplatesGrid');
            const section = document.getElementById('userTemplatesSection');
            
            if (Object.keys(saved).length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            container.innerHTML = '';

            Object.values(saved).forEach(tpl => {
                const config = tpl.config || tpl; // Handle legacy
                LOADED_TEMPLATES[tpl.id] = tpl;

                const card = document.createElement('div');
                card.className = 'glass-card p-5 rounded-xl border border-white/5 hover:border-neonBlue/50 transition-all group relative overflow-hidden';
                
                card.innerHTML = `
                    <div class="absolute top-0 right-0 bg-white/10 px-2 py-1 rounded-bl text-[10px] text-white font-mono border-l border-b border-white/20">CUSTOM</div>
                    <h4 class="text-white font-bold text-lg mb-1">${tpl.name}</h4>
                    <p class="text-gray-500 text-xs font-mono mb-4 truncate">${tpl.url}</p>
                    
                    <div class="space-y-2 mb-6">
                        <div class="flex justify-between text-[10px] text-gray-400 font-mono border-b border-white/5 pb-1">
                            <span>PAGINATION</span> <span class="${config.pagination ? 'text-neonGreen' : 'text-gray-600'}">${config.pagination ? 'ON' : 'OFF'}</span>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400 font-mono border-b border-white/5 pb-1">
                            <span>STEALTH</span> <span class="${config.stealth ? 'text-purple-400' : 'text-gray-600'}">${config.stealth ? 'ACTIVE' : 'OFF'}</span>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="loadTemplate('${tpl.id}')" class="cyber-btn flex-1 py-2 text-xs font-bold group-hover:shadow-[0_0_15px_rgba(0,255,255,0.3)]">LOAD</button>
                        <button onclick="deleteTemplate('${tpl.id}')" class="text-gray-500 hover:text-red-500 px-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function deleteTemplate(id) {
            if(!confirm("Delete this template?")) return;
            const saved = JSON.parse(localStorage.getItem('user_templates') || '{}');
            delete saved[id];
            localStorage.setItem('user_templates', JSON.stringify(saved));
            renderUserTemplates();
        }

        function updateBuiltUrl() {
            if (!currentUrlBuilder) return;
            
            let url = currentUrlBuilder.pattern;
            const inputs = document.querySelectorAll('.builder-input');
            
            inputs.forEach(input => {
                const key = input.getAttribute('data-key');
                const value = input.value.trim(); 
                // Simple replacement. Ideally we'd handle encoding.
                url = url.replace(`{${key}}`, encodeURIComponent(value));
            });
            
            document.getElementById('url').value = url;
        }

        var editor = CodeMirror.fromTextArea(document.getElementById("query"), {
            mode: "javascript",
            theme: "midnight",
            lineNumbers: true,
            tabSize: 4,
            indentUnit: 4,
            lineWrapping: true
        });

        // --- SCHEMA WIZARD LOGIC ---
        function switchSchemaMode(mode) {
            const formView = document.getElementById('schema-mode-form');
            const jsonView = document.getElementById('schema-mode-json');
            const btnForm = document.getElementById('btn-schema-form');
            const btnJson = document.getElementById('btn-schema-json');

            if (mode === 'form') {
                // Sync JSON to Form first (Best effort)
                syncFormFromJson();
                
                formView.classList.remove('hidden');
                jsonView.classList.add('hidden');
                
                btnForm.classList.add('bg-white/10', 'text-neonBlue', 'border-neonBlue/30');
                btnForm.classList.remove('text-gray-500', 'border-transparent');
                btnJson.classList.remove('bg-white/10', 'text-white');
                btnJson.classList.add('text-gray-500', 'border-transparent');
            } else {
                formView.classList.add('hidden');
                jsonView.classList.remove('hidden');
                
                // Refresh editor
                if(editor) setTimeout(() => editor.refresh(), 50);

                btnJson.classList.add('bg-white/10', 'text-white');
                btnJson.classList.remove('text-gray-500', 'border-transparent');
                btnForm.classList.remove('bg-white/10', 'text-neonBlue', 'border-neonBlue/30');
                btnForm.classList.add('text-gray-500', 'border-transparent');
            }
        }

        function handleEntityChange() {
            const select = document.getElementById('schemaEntitySelect');
            const custom = document.getElementById('schemaEntityCustom');
            
            if (select.value === 'custom') {
                custom.classList.remove('hidden');
                custom.focus();
            } else {
                custom.classList.add('hidden');
            }
            updateSchemaFromForm();
        }

        function addFieldRow(value = '') {
            const container = document.getElementById('schemaFieldsContainer');
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center group';
            div.innerHTML = `
                <input type="text" class="schema-field-input cyber-input w-full h-10 px-3 rounded text-xs font-mono bg-black/60 focus:border-neonGreen transition-colors" 
                    placeholder="Field name (e.g. title, price)" value="${value}" oninput="updateSchemaFromForm()">
                <button onclick="removeFieldRow(this)" class="text-gray-600 hover:text-red-500 p-2 transition opacity-0 group-hover:opacity-100">
                    &times;
                </button>
            `;
            container.appendChild(div);
            
            // If adding manual, focus it
            if (value === '') {
                div.querySelector('input').focus();
            }
            updateSchemaFromForm();
        }

        function removeFieldRow(btn) {
            btn.parentElement.remove();
            updateSchemaFromForm();
        }

        function updateSchemaFromForm() {
            const select = document.getElementById('schemaEntitySelect');
            let entity = select.value;
            if (entity === 'custom') {
                entity = document.getElementById('schemaEntityCustom').value.trim() || 'items';
            }
            
            const fields = [];
            document.querySelectorAll('.schema-field-input').forEach(input => {
                const val = input.value.trim();
                if (val) fields.push(val);
            });
            
            if (fields.length === 0) {
                // Don't update JSON if empty, or set basic default?
                // Let's set basic default to valid syntax
                // fields.push('name'); 
            }

            // Construct AgentQL Query
            let queryStr = `{\n    ${entity}[] {\n`;
            fields.forEach(f => queryStr += `        ${f}\n`);
            queryStr += `    }\n}`;
            
            if (editor) {
                // Only update if content changed significantly or if focused in form?
                // We update always to keep in sync
                editor.setValue(queryStr);
            } else {
                document.getElementById('query').value = queryStr;
            }
        }

        function syncFormFromJson() {
            const raw = editor ? editor.getValue() : document.getElementById('query').value;
            
            // Simple Regex Parser for format: { entity[] { field1 field2 ... } }
            // This is fragile but works for standard wizard output
            try {
                // Extract entity
                const entityMatch = raw.match(/(\w+)\[\]\s*\{/);
                if (!entityMatch) return; // Complex or invalid format, keep wizard as is or reset?
                
                let entity = entityMatch[1];
                
                // Extract Content inside brackets
                // Find first { and last }
                const firstBrace = raw.indexOf('{', raw.indexOf(entity));
                const lastBrace = raw.lastIndexOf('}');
                
                if (firstBrace === -1 || lastBrace === -1) return;
                
                const content = raw.substring(firstBrace + 1, lastBrace);
                
                // Split by whitespace/newlines and filter out braces
                const fields = content.split(/\s+/).filter(s => {
                    const trimmed = s.trim();
                    return trimmed.length > 0 && !trimmed.includes('{') && !trimmed.includes('}');
                });
                
                // Update UI
                const select = document.getElementById('schemaEntitySelect');
                const custom = document.getElementById('schemaEntityCustom');
                
                // Check if entity is in options
                let found = false;
                for(let i=0; i<select.options.length; i++) {
                    if (select.options[i].value === entity) {
                        select.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                
                if (!found) {
                    select.value = 'custom';
                    custom.value = entity;
                    custom.classList.remove('hidden');
                } else {
                    custom.classList.add('hidden');
                }
                
                // Update Fields
                const container = document.getElementById('schemaFieldsContainer');
                container.innerHTML = '';
                fields.forEach(f => addFieldRow(f));
                
            } catch (e) {
                console.error("Failed to sync form from JSON", e);
            }
        }

        // Initialize Wizard with Defaults
        setTimeout(() => {
            addFieldRow('name');
            addFieldRow('price');
            addFieldRow('rating');
            updateSchemaFromForm();
        }, 500);


        // Tab Logic
        function switchTab(tabId) {
            // Hide all views
            ['setup', 'schema', 'config'].forEach(id => {
                document.getElementById('view-' + id).classList.add('hidden');
                
                // Reset tab style
                const tab = document.getElementById('tab-' + id);
                tab.classList.remove('text-white', 'border-neonBlue', 'border-neonGreen', 'border-neonPink', 'bg-white/5');
                tab.classList.add('text-gray-500', 'border-transparent');
            });

            // Show selected view
            const view = document.getElementById('view-' + tabId);
            view.classList.remove('hidden');
            if (tabId === 'schema') view.classList.add('flex', 'flex-col'); // Flex fix for schema

            // Style active tab
            const activeTab = document.getElementById('tab-' + tabId);
            activeTab.classList.remove('text-gray-500', 'border-transparent');
            activeTab.classList.add('text-white', 'bg-white/5');
            
            if (tabId === 'setup') activeTab.classList.add('border-neonBlue');
            if (tabId === 'schema') activeTab.classList.add('border-neonGreen');
            if (tabId === 'config') activeTab.classList.add('border-neonPink');

            // Refresh editor if schema
            if (tabId === 'schema' && editor) {
                setTimeout(() => editor.refresh(), 50);
            }
        }

        // Summary Logic
        function updateSummary() {
            const url = document.getElementById('url').value;
            let site = "CUSTOM";
            try {
                if (url) site = new URL(url).hostname.replace('www.', '');
            } catch(e) {}

            const pages = document.getElementById('pagination').checked 
                ? `${document.getElementById('startPage').value}-${document.getElementById('endPage').value}` 
                : '1';
            
            const stealth = document.getElementById('stealthMode').checked ? 'STEALTH' : 'STD';
            const auth = (document.getElementById('loginEnabled').checked || document.getElementById('sessionEnabled').checked) ? 'AUTH' : 'GUEST';

            const summary = `${site} ‚Ä¢ PGS: ${pages} ‚Ä¢ ${stealth} ‚Ä¢ ${auth}`;
            document.getElementById('configSummary').innerText = summary;
        }

        // Initial Load
        switchTab('setup'); // Start on setup
        updateSummary();

        // Exclusive Accordion Logic (REMOVED in favor of tabs)
        // ...

        // Slider Logic
        function updateWaitDisplay(val) {
            document.getElementById('waitDisplay').innerText = val + 's';
            const min = 1, max = 15;
            const percent = ((val - min) / (max - min)) * 100;
            document.getElementById('sliderTrack').style.width = percent + '%';
            document.getElementById('sliderThumb').style.left = percent + '%';
        }

        // Auth & Logic
        async function checkAuth() {
            if (!supabase) return; // Should be called after init

            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            const user = session.user;
            // Use metadata from Google or fallback
            const name = user.user_metadata.full_name || user.email.split('@')[0];
            const avatar = user.user_metadata.avatar_url || user.user_metadata.picture || 'https://ui-avatars.com/api/?name=' + name;

            document.getElementById('userName').textContent = name;
            document.getElementById('userAvatar').src = avatar;

            // Record Login History
            await recordLoginHistory(user.id);
            // Fetch Profile & Credits
            await fetchProfile(user.id);
        }

        async function recordLoginHistory(userId) {
            // Simple debounce: check if we logged this in the last 5 mins in this session
            const lastLog = sessionStorage.getItem('last_login_log');
            if (lastLog && (Date.now() - parseInt(lastLog)) < 5 * 60 * 1000) {
                return;
            }

            try {
                await supabase.from('login_history').insert([{
                    user_id: userId,
                    user_agent: navigator.userAgent,
                    ip_address: 'client-side', // Real IP would be captured by RLS or backend ideally
                    metadata: { platform: navigator.platform }
                }]);
                sessionStorage.setItem('last_login_log', Date.now().toString());
            } catch (e) {
                console.error("Failed to log login history:", e);
            }
        }

        async function fetchProfile(userId) {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('subscription_tier, data_usage_mb_used, data_usage_mb_limit')
                    .eq('id', userId)
                    .single();
                
                if (data) {
                    const limit = parseFloat(data.data_usage_mb_limit || 10);
                    const used = parseFloat(data.data_usage_mb_used || 0);
                    const left = Math.max(0, limit - used);
                    const tier = (data.subscription_tier || 'FREE').toUpperCase();
                    
                    // Update Stats Bar
                    document.getElementById('statUsed').innerText = `${used.toFixed(2)} MB`;
                    document.getElementById('statLeft').innerText = `${left.toFixed(2)} MB`;
                    document.getElementById('statPlan').innerText = tier;
                }
            } catch (e) {
                console.error("Failed to fetch profile:", e);
            }
        }

        async function logout() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            localStorage.clear(); // Clear any legacy items
            window.location.href = '/';
        }

        // UI Logic: Toggles
        // Re-bind toggles since IDs moved
        const toggles = [
            { id: 'pagination', panel: 'paginationControls' },
            { id: 'loginEnabled', panel: 'loginParams', conflicts: 'sessionEnabled' },
            { id: 'sessionEnabled', panel: 'sessionParams', conflicts: 'loginEnabled' },
            { id: 'stealthMode', panel: 'jitterPanel' }
        ];

        toggles.forEach(t => {
            const el = document.getElementById(t.id);
            if(!el) return;
            el.addEventListener('change', function() {
                const panel = document.getElementById(t.panel);
                if (this.checked) {
                    panel.classList.remove('hidden');
                    if (t.conflicts) {
                        document.getElementById(t.conflicts).checked = false;
                        document.getElementById(toggles.find(x => x.id === t.conflicts).panel).classList.add('hidden');
                    }
                } else {
                    panel.classList.add('hidden');
                }
                updateSummary(); // Also update summary
            });
        });

        function closeAllModals() {
            document.querySelectorAll('[id$="Modal"]').forEach(el => el.classList.add('hidden'));
        }

        async function openHistoryModal() {
            closeAllModals();
            document.getElementById('historyModal').classList.remove('hidden');
            
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-neonBlue animate-pulse">LOADING LOGS...</td></tr>';

            if (!supabase) return;

            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const { data, error } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                tbody.innerHTML = '';
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">NO MISSION LOGS FOUND</td></tr>';
                    return;
                }

                data.forEach(job => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-white/5 hover:bg-white/5 transition';
                    
                    let statusColor = 'text-gray-500';
                    if (job.status === 'completed') statusColor = 'text-neonGreen';
                    else if (job.status === 'failed') statusColor = 'text-red-500';
                    else if (job.status === 'running') statusColor = 'text-neonBlue animate-pulse';

                    const date = new Date(job.created_at).toLocaleString();
                    const usage = job.data_usage_mb ? parseFloat(job.data_usage_mb).toFixed(4) + ' MB' : '0.00 MB';
                    
                    // Calculate items
                    let itemCount = '-';
                    if (job.data) {
                        if (Array.isArray(job.data)) itemCount = job.data.length;
                        else if (job.data.data && Array.isArray(job.data.data)) itemCount = job.data.data.length;
                        else if (typeof job.data === 'object') {
                             const listKey = Object.keys(job.data).find(k => Array.isArray(job.data[k]));
                             if (listKey) itemCount = job.data[listKey].length;
                        }
                    }

                    row.innerHTML = `
                        <td class="p-4 ${statusColor} font-bold uppercase text-xs">${job.status}</td>
                        <td class="p-4 truncate max-w-[200px]" title="${job.url}">${job.url}</td>
                        <td class="p-4 font-mono text-xs text-neonBlue">${itemCount}</td>
                        <td class="p-4 font-mono text-xs">${usage}</td>
                        <td class="p-4 text-xs text-gray-500">${date}</td>
                        <td class="p-4 text-right">
                            ${job.status === 'completed' && job.data ? 
                                `<button onclick="loadJobData('${job.id}')" class="text-neonBlue hover:text-white text-xs underline">LOAD DATA</button>` : 
                                '<span class="text-gray-600">-</span>'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (e) {
                console.error("History Error:", e);
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">ERROR: ${e.message}</td></tr>`;
            }
        }


        async function loadJobData(jobId) {
            if (!supabase) return;
            
            // Show Loading using new view system
            hideAllOutputs();
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.classList.remove('hidden');
                const loadingText = document.getElementById('loadingText');
                if (loadingText) loadingText.innerText = "FETCHING ARTIFACT...";
            }

            try {
                // Check if we already have the data in the row context or fetch fresh
                const { data, error } = await supabase
                    .from('jobs')
                    .select('data')
                    .eq('id', jobId)
                    .single();

                if (error) throw error;

                if (!data || !data.data) {
                    throw new Error("Artifact is empty or corrupted.");
                }

                currentData = data.data; // Set global for export
                renderResults(currentData);
                
                // Close modal to show results
                closeAllModals();

            } catch (e) {
                console.error("Load Error:", e);
                showStatus('error', e.message);
            }
        }

        async function runScraper() {
            const btn = document.getElementById('scrapeBtn');
            
            // Check if cancelling
            if (btn.innerHTML.includes('CANCEL')) {
                if (currentJobId) {
                    await fetch(`/job/${currentJobId}/cancel`, { method: 'POST' });
                    clearInterval(pollInterval);
                    
                    // Show Cancelled State
                    showStatus('cancelled');
                    resetButton();
                    return;
                }
            }

            const url = document.getElementById('url').value;
            const query = editor.getValue(); 
            const pagination = document.getElementById('pagination').checked;
            const startPage = parseInt(document.getElementById('startPage').value) || 1;
            const endPage = parseInt(document.getElementById('endPage').value) || 1;
            const maxPages = pagination ? Math.max(1, endPage - startPage + 1) : 1;

            const loginEnabled = document.getElementById('loginEnabled').checked;
            const loginUrl = document.getElementById('loginUrl').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const sessionEnabled = document.getElementById('sessionEnabled').checked;
            
            let sessionJson = null;
            if (sessionEnabled) {
                try {
                    const raw = document.getElementById('sessionJson').value;
                    if (raw) sessionJson = JSON.parse(raw);
                } catch (e) {
                    alert("Invalid JSON in Session box.");
                    return;
                }
            }

            // Loading State
            btn.innerHTML = '<span class="animate-pulse">CANCEL OPERATION</span>';
            btn.classList.add('border-red-500', 'text-red-500'); // Style for cancel
            
            // Show Loading
            showLoading(url);

            // Get User ID for billing
            let userId = null;
            if (supabase) {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) userId = session.user.id;
            }

            try {
                // 1. Start Job
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        query: query,
                        use_local_backend: true,
                        model_name: "gemini-2.0-flash-exp",
                        wait_time: 2,
                        pagination_enabled: pagination,
                        max_pages: maxPages,
                        login_enabled: loginEnabled,
                        login_url: loginUrl,
                        username: username,
                        password: password,
                        session_json: sessionJson,
                        stealth_mode: document.getElementById('stealthMode').checked,
                        user_id: userId
                    })
                });

                const startData = await response.json();
                
                if (!response.ok || !startData.job_id) {
                    throw new Error(startData.error || "Failed to start job (No ID returned)");
                }

                currentJobId = startData.job_id;

                // 2. Poll Status
                pollInterval = setInterval(async () => {
                    try {
                        const statusRes = await fetch(`/job/${currentJobId}`);
                        
                        if (!statusRes.ok) {
                            if (statusRes.status === 404) {
                                console.warn("Job lost (404). stopping poll.");
                                clearInterval(pollInterval);
                                renderError("Connection lost with job (404). Please try again.");
                                resetButton();
                                return;
                            }
                            // Other errors, maybe transient, keep polling or count errors?
                            // For now, let's log and continue, but maybe stop if too many?
                        }

                        const statusData = await statusRes.json();

                        if (statusData.status === 'completed') {
                            clearInterval(pollInterval);
                            currentData = statusData.data; // Store for download
                            renderResults(statusData.data);
                            resetButton();
                        } else if (statusData.status === 'failed') {
                            clearInterval(pollInterval);
                            renderError(statusData.error);
                            resetButton();
                        } else if (statusData.status === 'cancelled') {
                            clearInterval(pollInterval);
                            showStatus('cancelled');
                            resetButton();
                        }
                    } catch (e) {
                        console.error("Poll error", e);
                    }
                }, 2000); // Poll every 2s
                
            } catch (error) {
                renderError(error.message);
                resetButton();
            }
        }

        function resetButton() {
            const btn = document.getElementById('scrapeBtn');
            btn.innerHTML = 'Initialize Extraction';
            btn.classList.remove('border-red-500', 'text-red-500');
            btn.disabled = false;
        }

        // New Helper Functions for View Management
        function hideAllOutputs() {
            ['outputPlaceholder', 'loadingSpinner', 'statusMessage', 'jsonView', 'tableView'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        }

        function showLoading(url) {
            hideAllOutputs();
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.remove('hidden');
            document.getElementById('loadingText').innerText = `Target: ${url}`;
        }

        function showStatus(type, msg = '') {
            hideAllOutputs();
            const div = document.getElementById('statusMessage');
            div.classList.remove('hidden');
            
            if (type === 'cancelled') {
                div.innerHTML = `
                    <div class="text-yellow-500 text-4xl">üõë</div>
                    <div class="text-yellow-500 text-xs tracking-widest uppercase">OPERATION ABORTED BY USER</div>
                `;
            } else if (type === 'error') {
                div.innerHTML = `
                    <div class="p-6 border border-red-500/50 bg-red-900/20 text-red-400 font-mono">
                        <h3 class="font-bold mb-2 text-lg">CRITICAL FAILURE</h3>
                        <p class="text-xs">${msg}</p>
                    </div>
                `;
            }
        }

        function renderResults(data) {
            hideAllOutputs();
            
            // Calculate metrics (same as before)
            let itemCount = 0;
            let targetArray = null;

            if (data) {
                if (Array.isArray(data)) {
                    targetArray = data;
                    itemCount = data.length;
                } else if (data.data && Array.isArray(data.data)) {
                    targetArray = data.data;
                    itemCount = data.data.length;
                } else if (typeof data === 'object') {
                    const listKey = Object.keys(data).find(k => Array.isArray(data[k]));
                    if (listKey) {
                        targetArray = data[listKey];
                        itemCount = data[listKey].length;
                    }
                }
            }
            
            const jsonString = JSON.stringify(data, null, 2);
            
            // Safe update of header
            const rc = document.getElementById('resultCount');
            const cc = document.getElementById('charCount');
            if(rc) rc.innerText = `ITEMS: ${itemCount}`;
            if(cc) cc.innerText = `SIZE: ${formatBytes(jsonString.length)}`;
            
            // Render JSON View
            const jsonView = document.getElementById('jsonView');
            if(jsonView) jsonView.innerText = jsonString;
            
            // Render Table View
            const tableView = document.getElementById('tableView');
            if(tableView) {
                tableView.innerHTML = '';

                if (targetArray && targetArray.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'w-full text-left border-collapse text-xs';
                    
                    // Get headers
                    const headers = Object.keys(targetArray[0]);
                    
                    // Create Head
                    const thead = document.createElement('thead');
                    thead.className = 'bg-white/5 text-neonBlue font-mono sticky top-0';
                    const headerRow = document.createElement('tr');
                    headers.forEach(h => {
                        const th = document.createElement('th');
                        th.className = 'p-2 border-b border-white/10 uppercase font-bold tracking-wider whitespace-nowrap';
                        th.innerText = h;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    // Create Body
                    const tbody = document.createElement('tbody');
                    tbody.className = 'font-mono text-gray-300';
                    targetArray.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                        headers.forEach(h => {
                            const td = document.createElement('td');
                            td.className = 'p-2 truncate max-w-[200px] align-top';
                            td.title = typeof row[h] === 'object' ? JSON.stringify(row[h]) : row[h];
                            
                            let val = row[h];
                            if (val === null || val === undefined) val = '-';
                            else if (typeof val === 'object') val = '[OBJ]';
                            else if (String(val).startsWith('http')) val = `<a href="${val}" target="_blank" class="text-neonPink hover:underline">LINK</a>`;
                            
                            td.innerHTML = val;
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    tableView.appendChild(table);
                } else {
                    tableView.innerHTML = '<div class="text-center text-gray-500 p-8">NO TABULAR DATA DETECTED</div>';
                }
            }

            // Default to JSON view if not already set
            const btnTable = document.getElementById('viewBtnTable');
            if (btnTable && btnTable.classList.contains('bg-white/10')) {
                toggleView('table');
            } else {
                toggleView('json');
            }
        }

        function toggleView(mode) {
            const jsonView = document.getElementById('jsonView');
            const tableView = document.getElementById('tableView');
            const btnJson = document.getElementById('viewBtnJson');
            const btnTable = document.getElementById('viewBtnTable');
            
            // Only toggle if both exist (data loaded)
            if (!jsonView || !tableView || jsonView.classList.contains('hidden') && tableView.classList.contains('hidden')) {
                 // Could be loading or empty, check visibility logic in showLoading/renderResults
                 // Actually, we rely on hideAllOutputs() to manage visibility state.
                 // If BOTH are hidden, we shouldn't be toggling (no data).
                 // But hideAllOutputs hides ALL. renderResults shows ONE.
                 // So if one is shown, we can toggle.
            }

            if (mode === 'json') {
                if(jsonView) jsonView.classList.remove('hidden');
                if(tableView) tableView.classList.add('hidden');
                
                if(btnJson) { btnJson.classList.add('bg-white/10', 'text-white'); btnJson.classList.remove('text-gray-500'); }
                if(btnTable) { btnTable.classList.remove('bg-white/10', 'text-white'); btnTable.classList.add('text-gray-500'); }
            } else {
                if(jsonView) jsonView.classList.add('hidden');
                if(tableView) tableView.classList.remove('hidden');
                
                if(btnTable) { btnTable.classList.add('bg-white/10', 'text-white'); btnTable.classList.remove('text-gray-500'); }
                if(btnJson) { btnJson.classList.remove('bg-white/10', 'text-white'); btnJson.classList.add('text-gray-500'); }
            }
        }

        function renderError(msg) {
            showStatus('error', msg);
        }

        // Helper: Format Bytes
        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        // --- Action Functions ---

        function copyToClipboard() {
            if (!currentData) return;
            const str = JSON.stringify(currentData, null, 2);
            navigator.clipboard.writeText(str).then(() => {
                const btn = document.querySelector('button[onclick="copyToClipboard()"]');
                const original = btn.innerText;
                btn.innerText = "[COPIED!]";
                btn.classList.add('text-neonGreen');
                setTimeout(() => {
                    btn.innerText = original;
                    btn.classList.remove('text-neonGreen');
                }, 2000);
            });
        }

        function downloadRawJson() {
            if (!currentData) {
                alert("No data to download.");
                return;
            }
            // If the data is wrapped in a 'data' key from the API response, unwrap it for the file if desired, 
            // OR keep the full response. Usually users want the extraction result.
            // Our API returns { data: {...}, message: ... }. Let's download the inner data if present.
            const payload = currentData.data || currentData;
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "scrape_results.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function downloadCsv() {
            if (!currentData) {
                alert("No data to download.");
                return;
            }
            
            // Unwrap { data: ... } if present
            const payload = currentData.data || currentData;

            // Heuristic: Find the first array
            let targetArray = null;
            for (const key in payload) {
                if (Array.isArray(payload[key])) {
                    targetArray = payload[key];
                    break;
                }
            }

            if (!targetArray || targetArray.length === 0) {
                alert("No list found to convert to CSV.");
                return;
            }

            // Extract headers
            const headers = Object.keys(targetArray[0]);
            const csvRows = [];
            csvRows.push(headers.join(','));

            for (const row of targetArray) {
                const values = headers.map(header => {
                    const val = row[header] || ''; 
                    const escaped = ('' + val).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "scrape_results.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
    <style>
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,255,255,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0,255,255,0.4); }
    </style>
</body>
</html>
